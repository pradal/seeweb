{% extends "templates/project/layout_content.jinja2" %}

{% block project_css -%}

<link href="{{ request.static_url('seeweb:project/content/workflow_node/static/style.css') }}" rel="stylesheet">

<script type="text/javascript" src="{{ request.static_url('seeweb:project/content/workflow/static/eve.js') }}"></script>
<script type="text/javascript" src="{{ request.static_url('seeweb:project/content/workflow/static/raphael.js') }}"></script>

{%- endblock %}

{% block project_content_body -%}

<div id="node_canvas">
</div>

<div class="row">
    <a class="btn btn-warning" href="{{ request.route_url('project_content_workflow_node_usage', pid=project.id, cid=cnt_item.id) }}">Usage</a>
</div>

<p>Descr: {{ cnt_item.description }}</p>
<p>Function: {{ cnt_def['function'] }}</p>

<div class="well debug">
    {{ cnt_item.definition }}
</div>

{%- endblock %}

{% block project_js -%}

<script>
    window.onload = function() {
        var ndef = {{ cnt_item.definition|safe }};
        var interfaces = {{ interfaces|safe }};

        var vw = 800;
        var vh = 300;
        var paper = new Raphael(document.getElementById('node_canvas'), vw, vh);

        var ori_x = vw / 2.;
        var ori_y = vh / 2.;

        // body
        var pr = 15;

        var nb = Math.max(ndef.inputs.length, ndef.outputs.length);
        var nw = Math.max(300, pr * (nb * 6 + 4));
        var nh = 150;

        var bg = paper.rect(ori_x - nw / 2., ori_y - nh / 2., nw, nh, 15);
        bg.attr({'gradient': '90-#8c8cff-#c8c8c8',
                 'stroke': '#808080',
                 'stroke-width': 1,
                 'stroke-linejoin': 'round'});

        // label
        var label = paper.text(ori_x, ori_y, ndef['name']);
        label.attr({'fill': '#000000',
                    'font-size': '22px',
                    'font-family': 'verdana'});

        // ports
        nb = ndef.inputs.length;
        for (i in ndef.inputs){
            var input = ndef.inputs[i];
            var idef = interfaces[input['interface']];
            var px = ori_x - (nb - 1) * 3 * pr + i * pr * 6;
            var py = ori_y + -nh / 2.;
            var port = paper.circle(px, py, pr);
            port.attr({'gradient': '180-#3333ff-#2222ff',
                       'stroke': '#000000',
                       'stroke-width': 1});

            var label = paper.text(px, py - 2 * pr, input['name']);

            label.attr({'fill': '#000000',
                        'font-size': '18px',
                        'font-family': 'verdana'});

            var iface = paper.text(px, py + 2 * pr, input['interface'].substr(0, 10));

            iface.attr({'fill': '#000000',
                        'font-size': '10px',
                        'font-family': 'verdana'});

            if (idef != null) {
                port.attr({'href': idef['url']});
                iface.attr({'href': idef['url']});
            }
        }

        nb = ndef.outputs.length;
        for (i in ndef.outputs){
            var output = ndef.outputs[i];
            var idef = interfaces[output['interface']];
            var px = ori_x - (nb - 1) * 3 * pr + i * pr * 6;
            var py =ori_y + nh / 2.;
            var port = paper.circle(px, py, pr);
            port.attr({'gradient': '180-#ffff33-#9a9a00',
                       'stroke': '#000000',
                       'stroke-width': 1});

            var label = paper.text(px, py - 2 * pr, output['name']);

            label.attr({'fill': '#000000',
                        'font-size': '18px',
                        'font-family': 'verdana'});

            var iface = paper.text(px, py + 2 * pr, output['interface'].substr(0, 10));

            iface.attr({'fill': '#000000',
                        'font-size': '10px',
                        'font-family': 'verdana'});

            if (idef != null) {
                port.attr({'href': idef['url']});
                iface.attr({'href': idef['url']});
            }
        }
    }
</script>

{%- endblock %}
